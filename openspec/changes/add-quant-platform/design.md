# 技术架构设计

## Context

本项目构建一个面向个人量化投资者的专属平台（网页版），整合数据获取、策略开发、回测优化、风控管理、实时通知等核心功能。项目需满足以下约束：

### 关键约束
- **用户规模**：单用户使用，无需支持高并发，重点保障操作流畅性
- **平台载体**：网页版优先，响应式设计，支持PC端主流浏览器（Chrome、Edge、Firefox）及平板设备
- **数据安全**：个人量化策略代码及交易数据需双重加密存储，符合《网络安全等级保护基本要求》
- **合规要求**：交易行为需符合《证券法》及金融监管总局要求
- **性能要求**：行情数据延迟≤50ms，页面响应时间≤2秒，回测任务成功率≥99.9%

### 技术背景
- 前端使用现代化JavaScript框架（React/Vue）实现响应式Web应用
- 后端使用Python生态（与量化策略开发语言一致）
- 数据源主要依赖akshare开源框架（覆盖A股、期货、基金等多市场数据）
- 集成第三方服务：微信小程序推送、券商行情接口

## Goals / Non-Goals

### Goals
1. **统一数据管理**：整合多市场行情、财务、因子数据，提供统一查询与可视化接口
2. **专业开发环境**：集成Jupyter、Backtrader、akshare等工具，支持策略全生命周期管理
3. **贴近实盘回测**：真实交易参数配置，支持实盘记录导入与历史场景复现
4. **个性化风控**：账户级与策略级风控规则，实时监控与微信推送
5. **数据安全保障**：端到端加密存储与传输，支持本地备份

### Non-Goals
- 移动原生应用（iOS/Android App）
- 实盘自动交易执行（仅提供信号提醒）
- 多用户协作与社区功能
- 付费数据服务分级（初期统一使用开源数据）

## Technical Decisions

### 1. 架构模式：前后端分离 + 微服务化

**决策**：采用前后端分离架构，后端按业务领域拆分为多个服务模块。

**理由**：
- 前后端分离便于独立开发与部署，前端专注交互体验，后端专注业务逻辑
- 微服务化拆分（数据服务、策略引擎、回测引擎、风控引擎、通知服务）降低模块耦合，便于后续扩展
- 单用户场景下，服务可部署在单机，避免分布式复杂度

**架构图**：
```
┌─────────────────────────────────────────────────────────┐
│                    前端 Web 应用                        │
│         (React/Vue + TypeScript + Ant Design)           │
└───────────────────┬─────────────────────────────────────┘
                    │ HTTPS/WebSocket
┌───────────────────▼─────────────────────────────────────┐
│                   API 网关 (Nginx)                      │
└───────────────────┬─────────────────────────────────────┘
                    │
        ┌───────────┴───────────┬─────────────┬───────────┐
        ▼                       ▼             ▼           ▼
┌───────────────┐   ┌───────────────┐  ┌──────────┐  ┌──────────┐
│  用户认证服务 │   │  数据服务     │  │策略引擎  │  │风控引擎  │
│  (user-auth)  │   │(market-data)  │  │(strategy)│  │(risk)    │
└───────────────┘   └───────────────┘  └──────────┘  └──────────┘
                             │              │             │
        ┌────────────────────┼──────────────┴─────────────┘
        ▼                    ▼
┌───────────────┐   ┌───────────────┐
│  回测引擎     │   │  通知服务     │
│ (backtesting) │   │(notification) │
└───────────────┘   └───────────────┘
        │                    │
        └────────────┬───────┘
                     ▼
        ┌────────────────────────┐
        │   数据存储层            │
        │ - PostgreSQL (用户数据) │
        │ - MongoDB (策略代码)    │
        │ - Redis (缓存/会话)     │
        │ - InfluxDB (行情数据)   │
        └────────────────────────┘
```

### 2. 技术栈选型

#### 前端
- **框架**：React 18 + TypeScript（类型安全，组件化开发）
- **UI库**：Ant Design（成熟的企业级UI组件，支持图表与表单）
- **状态管理**：Zustand（轻量级，适合单用户场景）
- **图表库**：ECharts（支持K线图、热力图等金融图表）
- **代码编辑器**：Monaco Editor（VS Code同款编辑器，集成Jupyter Notebook渲染）

#### 后端
- **语言**：Python 3.11+（与量化策略语言一致）
- **Web框架**：FastAPI（高性能、自动生成API文档、原生支持异步）
- **任务队列**：Celery + Redis（处理耗时的回测任务）
- **实时通信**：WebSocket（行情推送、策略信号通知）
- **数据处理**：Pandas, NumPy, akshare（量化数据处理标准库）
- **回测框架**：Backtrader（成熟的Python回测框架）

#### 数据存储
- **PostgreSQL**：用户账户、策略配置、交易记录、风控规则（结构化数据）
- **MongoDB**：策略代码、回测报告、通知日志（文档型数据）
- **Redis**：会话管理、行情数据缓存、任务队列
- **InfluxDB**：时序行情数据（高效存储与查询K线、Tick数据）

#### 第三方集成
- **akshare**：开源行情数据接口
- **微信小程序推送**：通过微信服务号模板消息实现
- **短信服务**：阿里云短信服务（用户登录验证）

### 3. 数据流设计

#### 实时行情数据流
```
交易所行情 → akshare接口 → 数据服务 → InfluxDB存储
                            ↓
                      WebSocket推送 → 前端实时展示
                            ↓
                      策略引擎订阅 → 信号生成 → 通知服务推送
```

#### 策略开发与回测流
```
用户编辑策略 → Monaco Editor → 保存到MongoDB（加密）
                                  ↓
                          版本管理系统记录变更
                                  ↓
                       触发回测 → Celery任务队列
                                  ↓
                      回测引擎 + Backtrader + 历史数据
                                  ↓
                      生成回测报告 → 存储MongoDB
                                  ↓
                      WebSocket推送 → 前端展示结果
```

#### 风控与通知流
```
策略引擎/回测引擎 → 风控引擎实时校验规则
                        ↓
                  触发风控事件 → 通知服务
                        ↓
                  微信小程序推送 + 通知中心记录
                        ↓
                  用户查看并决策
```

### 4. 安全设计

#### 数据加密
- **传输加密**：全站HTTPS（SSL/TLS 1.3），WebSocket使用WSS协议
- **存储加密**：
  - 用户密码：bcrypt哈希（加盐）
  - 策略代码：AES-256加密存储，密钥使用KMS管理
  - 交易记录：敏感字段（价格、数量）AES-256加密
- **本地备份加密**：用户导出数据时可选设置密码，使用AES-256加密ZIP文件

#### 认证与授权
- **双重认证**：手机短信验证码 + 密码登录
- **JWT令牌**：有效期7天，支持刷新令牌延长有效期
- **异地登录预警**：检测IP地址变化，推送微信通知
- **会话管理**：30分钟无操作自动登出，Redis存储会话状态

#### 合规校验
- **交易权限校验**：创业板、科创板交易需验证用户权限
- **风控规则强制执行**：超仓位、超亏损自动阻止交易操作
- **操作审计日志**：记录所有敏感操作，保留5年

### 5. 性能优化策略

#### 前端优化
- **代码分割**：按路由懒加载模块，减少首屏加载时间
- **数据虚拟化**：长列表（如历史交易记录）使用虚拟滚动，避免DOM节点过多
- **图表性能**：ECharts开启DataZoom，限制单次渲染数据点≤5000
- **缓存策略**：静态资源CDN缓存，行情数据前端本地缓存1分钟

#### 后端优化
- **数据库索引**：用户ID、策略ID、时间戳字段建立索引
- **行情数据缓存**：Redis缓存最新行情（TTL=10秒），减少数据库查询
- **异步任务**：回测任务放入Celery队列异步执行，避免阻塞API响应
- **连接池**：数据库连接池（PostgreSQL/MongoDB）复用连接，减少开销

#### 数据存储优化
- **InfluxDB时序压缩**：K线数据按时间分片，旧数据自动压缩
- **MongoDB分片**：策略代码按用户ID分片（单用户场景可暂缓）
- **Redis过期策略**：行情缓存使用LRU淘汰策略

### 6. 部署架构

**单机部署方案**（适用于个人使用）：
```
┌─────────────────────────────────────────────────┐
│              云服务器 (4C8G)                    │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │  Docker Compose 容器编排                │   │
│  │                                         │   │
│  │  - Nginx (反向代理 + 静态资源)          │   │
│  │  - FastAPI 服务 (3个worker进程)         │   │
│  │  - Celery Worker (2个进程)              │   │
│  │  - PostgreSQL (用户数据)                │   │
│  │  - MongoDB (策略代码)                   │   │
│  │  - Redis (缓存/队列)                    │   │
│  │  - InfluxDB (行情数据)                  │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  数据盘挂载：/data (500GB SSD)                 │
└─────────────────────────────────────────────────┘
```

**备份策略**：
- 数据库每日自动备份到云存储（阿里云OSS/腾讯云COS）
- 策略代码实时同步云端，支持用户手动触发本地加密备份
- 回测报告保留最近100次，旧数据归档到对象存储

## Alternatives Considered

### 1. 数据存储：时序数据库选择
- **备选方案1**：PostgreSQL + TimescaleDB扩展
  - 优点：统一数据库技术栈，减少运维复杂度
  - 缺点：时序查询性能不如专业时序数据库
- **备选方案2**：InfluxDB
  - 优点：专为时序数据设计，查询性能优秀，自带数据压缩
  - 缺点：新增一个数据库组件
- **最终选择**：InfluxDB（性能优先，行情数据量大）

### 2. 策略开发环境：在线IDE选择
- **备选方案1**：JupyterLab完整集成
  - 优点：功能强大，社区成熟
  - 缺点：前端集成复杂，需额外权限管理
- **备选方案2**：Monaco Editor + Jupyter Kernel
  - 优点：轻量级，前端可控性强，支持自定义功能
  - 缺点：需自行实现代码执行与调试功能
- **最终选择**：Monaco Editor + 后端Jupyter Kernel（平衡功能与可控性）

### 3. 通知推送：微信推送方式选择
- **备选方案1**：微信公众号模板消息
  - 优点：开发简单，用户订阅即可接收
  - 缺点：需企业认证，消息触达率受限
- **备选方案2**：微信小程序订阅消息
  - 优点：触达率高,用户体验好
  - 缺点：需开发独立小程序
- **最终选择**：微信小程序订阅消息（用户体验优先）

## Risks / Trade-offs

### 风险1：akshare数据源稳定性
- **风险**：akshare依赖公开数据源，可能存在接口变更或数据中断
- **缓解措施**：
  - 内置数据获取异常重试机制（最多3次）
  - 本地缓存历史数据，数据源中断时使用缓存
  - 支持用户接入第三方数据源（如Wind）作为备选
  - 定期监控数据源健康状态，异常时推送预警

### 风险2：回测与实盘偏差
- **风险**：回测结果无法完全复现实盘表现（滑点、冲击成本、流动性）
- **缓解措施**：
  - 提供真实券商交易参数配置（佣金、印花税、滑点）
  - 支持导入实盘交易记录进行对比分析
  - 回测报告明确标注模拟与实盘的潜在差异点
  - 提供模拟交易功能，验证策略实盘可行性

### 风险3：策略代码安全
- **风险**：用户策略代码泄露或被恶意利用
- **缓解措施**：
  - 策略代码AES-256加密存储，密钥使用KMS管理
  - 代码传输使用HTTPS加密
  - 支持用户本地加密备份，设置独立密码
  - 定期安全扫描，防止SQL注入、XSS等攻击

### 权衡1：功能复杂度 vs 用户体验
- **权衡**：专业量化功能（如参数优化、因子分析）与简洁用户界面的平衡
- **决策**：采用分层UI设计，核心功能前置，高级功能折叠或进入子页面，提供引导教程

### 权衡2：实时性 vs 成本
- **权衡**：实时行情推送（WebSocket长连接）增加服务器负载
- **决策**：单用户场景下成本可控,采用WebSocket实现实时推送,提升用户体验

## Migration Plan

### 初始部署阶段（Phase 0）
1. 搭建开发环境：配置Docker Compose本地开发环境
2. 初始化数据库：创建表结构与索引
3. 部署测试环境：云服务器单机部署
4. 数据迁移：无历史数据，跳过

### 功能迭代策略
- **Phase 1**：用户认证 + 数据服务（行情查询、可视化）
- **Phase 2**：策略开发环境 + 代码版本管理
- **Phase 3**：回测引擎 + 回测报告
- **Phase 4**：风控引擎 + 微信通知
- **Phase 5**：模拟交易 + 实盘对比

### 数据备份与回滚
- 每个Phase上线前备份数据库
- 保留前一版本Docker镜像，支持快速回滚
- 策略代码版本管理天然支持回溯

## Open Questions

1. **券商接口对接**：需确认用户开户券商是否提供API接口，如何对接？
   - 建议：优先支持通达信、同花顺等通用行情软件接口

2. **微信小程序开发资质**：个人开发者是否可注册微信小程序并使用订阅消息功能？
   - 备选方案：如无法使用小程序，降级为微信公众号模板消息

3. **数据合规性**：akshare获取的公开数据是否涉及数据授权问题？
   - 建议：咨询法律顾问，必要时与数据服务商签订授权协议

4. **性能压力测试**：单机部署能否满足实时行情推送（数千只股票订阅）的性能需求？
   - 建议：上线前进行压力测试，必要时升级服务器配置或优化推送策略

5. **后续扩展性**：如果未来需要支持多用户，当前架构需要做哪些调整？
   - 建议：后端已按微服务拆分，扩展时只需增加服务实例数与负载均衡，数据库按用户ID分片
