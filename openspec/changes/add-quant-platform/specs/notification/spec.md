## ADDED Requirements

### Requirement: 微信小程序账号绑定
The system MUST 支持用户将APP账号与微信小程序一键绑定，引导完成推送权限授权，采用SSL加密传输保障消息安全。

#### Scenario: 首次绑定微信小程序
- **WHEN** 用户在APP中选择"绑定微信小程序"
- **THEN** 系统应生成绑定二维码
- **AND** 用户使用微信扫码后完成绑定
- **AND** 引导用户授权消息推送权限
- **AND** 所有数据传输使用SSL加密

#### Scenario: 解绑微信小程序
- **WHEN** 用户选择解绑微信小程序
- **THEN** 系统应取消绑定关系
- **AND** 停止向该微信账号推送消息
- **AND** 提示用户确认解绑操作

### Requirement: 推送权限细分管理
The system MUST 提供权限细分设置，支持用户仅接收特定类型的消息（如策略信号、风控提醒），屏蔽营销消息。

#### Scenario: 设置推送权限类型
- **WHEN** 用户进入消息推送设置页面
- **THEN** 系统应展示可选的消息类型：
  - 策略信号
  - 回测任务完成
  - 风控提醒
  - 价格触发
  - 涨跌幅异常
  - 系统通知
- **AND** 用户可单独开启或关闭每种类型的推送
- **AND** 营销消息默认关闭且不可强制推送

#### Scenario: 勿扰时段设置
- **WHEN** 用户设置晚上22:00-次日8:00为勿扰时段
- **THEN** 系统应在该时段内暂停普通消息推送
- **AND** 仅推送紧急风控预警消息（如触发止损）

### Requirement: 持仓关联触发机制
The system MUST 支持仅推送用户持仓/自选标的相关消息，避免无关信息干扰。

#### Scenario: 持仓标的价格触发推送
- **WHEN** 用户持仓的某只股票价格触及止损线
- **THEN** 系统应立即推送微信小程序通知
- **AND** 通知标题标注持仓标的名称

#### Scenario: 自选股涨跌幅异常推送
- **WHEN** 用户自选股单日涨跌幅≥5%
- **THEN** 系统应推送涨跌幅异常通知
- **AND** 仅推送自选股，不推送其他股票的异常

#### Scenario: 非持仓标的消息过滤
- **WHEN** 系统检测到某只股票的策略信号
- **AND** 该股票不在用户的持仓或自选列表中
- **THEN** 系统不推送该消息

### Requirement: 结构化消息内容
The system MUST 按照"类型标识-标的信息-触发条件-核心数据-操作指引"格式推送消息，附带APP内快速跳转链接。

#### Scenario: 推送策略信号消息
- **WHEN** 用户策略触发买入信号
- **THEN** 系统应推送格式化消息：
  - 类型标识：【策略信号】
  - 标的信息：贵州茅台(600519)
  - 触发条件：15分钟K线触发MACD金叉
  - 核心数据：当前价1890元
  - 操作指引：建议查看策略详情
- **AND** 附带APP内跳转链接（点击直达策略详情页）

#### Scenario: 推送风控预警消息
- **WHEN** 用户策略最大回撤达到20%
- **THEN** 系统应推送格式化消息：
  - 类型标识：【风控预警】
  - 标的信息：沪深300ETF策略
  - 触发条件：最大回撤达22%
  - 核心数据：当前回撤22%，超过阈值20%
  - 操作指引：建议暂停运行并优化参数
- **AND** 附带风控管理页面跳转链接

### Requirement: 消息优先级与频率管控
The system MUST 支持用户设置推送优先级（紧急/普通/次要），极端行情触发紧急推送，普通消息可设置聚合推送避免高频打扰。

#### Scenario: 紧急消息即时推送
- **WHEN** 触发紧急风控预警（如单日亏损达上限）
- **THEN** 系统应立即推送，不受频率限制
- **AND** 消息标记为【紧急】优先级

#### Scenario: 普通消息聚合推送
- **WHEN** 用户设置普通消息"每小时聚合推送"
- **AND** 一小时内触发多条策略信号
- **THEN** 系统应在整点时将多条消息合并为一条推送
- **AND** 消息内容列举所有触发的策略信号

#### Scenario: 日内首次触发提醒
- **WHEN** 用户设置某类消息"日内首次触发提醒"
- **AND** 同一标的当日第二次触发相同信号
- **THEN** 系统不重复推送
- **AND** 仅在通知中心记录

### Requirement: 通知中心管理面板
The system MUST 在网页端提供通知中心，集中展示所有推送记录，支持按"未读/已读""策略关联""标的分组"筛选，并可设置跟进提醒。

#### Scenario: 查看未读消息
- **WHEN** 用户打开通知中心
- **THEN** 系统应默认展示所有未读消息
- **AND** 消息按时间倒序排列
- **AND** 支持标记为已读或批量已读

#### Scenario: 按策略筛选消息
- **WHEN** 用户选择按"策略A"筛选消息
- **THEN** 系统应仅展示与"策略A"相关的所有消息
- **AND** 包含策略信号、回测完成、风控预警等类型

#### Scenario: 设置跟进提醒
- **WHEN** 用户查看某条消息后选择"稍后处理"
- **THEN** 系统应允许用户设置提醒时间（如1小时后）
- **AND** 到时间后再次推送该消息提醒

### Requirement: 异常预警强化
The system MUST 在策略触发最大回撤阈值、标的停牌/退市或数据源中断时推送紧急预警并附带风险说明。

#### Scenario: 最大回撤阈值预警
- **WHEN** 策略最大回撤达到用户设置的阈值（默认20%）
- **THEN** 系统应推送紧急预警消息
- **AND** 消息包含风险说明："策略回撤过大，建议暂停运行并检查策略逻辑"

#### Scenario: 标的停牌预警
- **WHEN** 用户持仓的某只股票停牌
- **THEN** 系统应推送停牌通知
- **AND** 说明停牌原因（如重大资产重组）及预计复牌时间

#### Scenario: 数据源中断预警
- **WHEN** 系统检测到行情数据源中断
- **THEN** 系统应推送数据源异常预警
- **AND** 提示"实时行情数据中断，策略信号可能延迟，建议检查网络或数据服务商"

### Requirement: 消息日志与分析
The system MUST 记录推送时间、触发条件、用户点击行为，生成月度通知分析报告，日志保留至少5年，支持导出。

#### Scenario: 记录消息推送日志
- **WHEN** 系统推送任何消息
- **THEN** 系统应记录：
  - 推送时间
  - 消息类型
  - 触发条件
  - 关联标的/策略
  - 用户是否点击查看
- **AND** 日志永久保存（至少5年）

#### Scenario: 生成月度分析报告
- **WHEN** 每月1日
- **THEN** 系统应自动生成上月的通知分析报告
- **AND** 报告内容包括：
  - 高频触发的策略
  - 关注标的活跃度
  - 消息点击率
  - 风控预警次数
- **AND** 用户可在通知中心查看或导出

#### Scenario: 导出消息日志
- **WHEN** 用户选择导出某段时间的消息日志
- **THEN** 系统应生成Excel或CSV格式文件
- **AND** 包含所有日志字段

### Requirement: 个性化推送规则配置
The system MUST 支持用户按投资场景自定义推送规则，如"仅接收持仓标的的止损提醒""创业板标的涨跌幅≥8%时推送"，支持多套规则保存与一键启停。

#### Scenario: 创建自定义推送规则
- **WHEN** 用户创建新规则"创业板标的涨跌幅≥8%时推送"
- **THEN** 系统应保存该规则
- **AND** 当创业板任一自选股涨跌幅≥8%时触发推送
- **AND** 其他板块股票涨跌幅≥8%不触发

#### Scenario: 保存多套规则方案
- **WHEN** 用户为不同投资场景创建多套规则（如"激进型""稳健型"）
- **THEN** 系统应分别保存各套规则
- **AND** 用户可随时切换启用的规则方案

#### Scenario: 一键启停规则
- **WHEN** 用户暂时不想接收某类推送
- **THEN** 系统应支持一键暂停该规则
- **AND** 不删除规则配置，可随时恢复启用
